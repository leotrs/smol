{% extends "base.html" %}

{% block title %}{{ graph.graph6 }} - SMOL{% endblock %}

{% block content %}
<hgroup>
    <h1><code>{{ graph.graph6 }}</code></h1>
    <p>{{ graph.n }} vertices, {{ graph.m }} edges</p>
</hgroup>

<div class="grid">
    <div>
        <div id="graph-viz" class="graph-viz" style="width: 300px; height: 300px;"></div>
    </div>
    <div>
        <h3>Properties</h3>
        <dl class="property-grid">
            <dt>Bipartite</dt>
            <dd>{{ "Yes" if graph.properties.is_bipartite else "No" }}</dd>

            <dt>Planar</dt>
            <dd>{{ "Yes" if graph.properties.is_planar else "No" }}</dd>

            <dt>Regular</dt>
            <dd>{{ "Yes" if graph.properties.is_regular else "No" }}</dd>

            <dt>Diameter</dt>
            <dd>{{ graph.properties.diameter if graph.properties.diameter else "∞" }}</dd>

            <dt>Girth</dt>
            <dd>{{ graph.properties.girth if graph.properties.girth else "∞ (acyclic)" }}</dd>

            <dt>Radius</dt>
            <dd>{{ graph.properties.radius if graph.properties.radius else "-" }}</dd>

            <dt>Degree range</dt>
            <dd>[{{ graph.properties.min_degree }}, {{ graph.properties.max_degree }}]</dd>

            <dt>Triangles</dt>
            <dd>{{ graph.properties.triangle_count }}</dd>
        </dl>
    </div>
</div>

<script>
function renderGraph() {
    const n = {{ graph.n }};
    const edges = {{ graph.edges | tojson }};

    const width = 300, height = 300;
    const nodes = Array.from({length: n}, (_, i) => ({id: i}));
    const links = edges.map(([s, t]) => ({source: s, target: t}));

    const svg = d3.select("#graph-viz")
        .append("svg")
        .attr("width", width)
        .attr("height", height)
        .style("cursor", "grab");

    // Container group for panning
    const g = svg.append("g");

    // Viewport pan (on SVG background)
    let pan = {x: 0, y: 0};
    svg.call(d3.drag()
        .on("start", () => svg.style("cursor", "grabbing"))
        .on("drag", (event) => {
            pan.x += event.dx;
            pan.y += event.dy;
            g.attr("transform", `translate(${pan.x},${pan.y})`);
        })
        .on("end", () => svg.style("cursor", "grab")));

    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(50))
        .force("charge", d3.forceManyBody().strength(-100))
        .force("center", d3.forceCenter(width / 2, height / 2));

    const style = getComputedStyle(document.documentElement);
    const nodeColor = style.getPropertyValue('--graph-node-color').trim();
    const edgeColor = style.getPropertyValue('--graph-edge-color').trim();

    const link = g.append("g")
        .selectAll("line")
        .data(links)
        .join("line")
        .attr("stroke", edgeColor)
        .attr("stroke-width", 2);

    const node = g.append("g")
        .selectAll("circle")
        .data(nodes)
        .join("circle")
        .attr("r", 8)
        .attr("fill", nodeColor)
        .style("cursor", "pointer")
        .call(d3.drag()
            .on("start", (event, d) => {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
                event.sourceEvent.stopPropagation();
            })
            .on("drag", (event, d) => {
                d.fx = event.x;
                d.fy = event.y;
            })
            .on("end", (event, d) => {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }));

    simulation.on("tick", () => {
        link
            .attr("x1", d => d.source.x)
            .attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x)
            .attr("y2", d => d.target.y);
        node
            .attr("cx", d => d.x)
            .attr("cy", d => d.y);
    });
}
</script>
<script src="https://d3js.org/d3.v7.min.js" onload="renderGraph()"></script>

<h3>Cospectral Mates</h3>
{% if graph.cospectral_mates.adj or graph.cospectral_mates.lap or graph.cospectral_mates.nb or graph.cospectral_mates.nbl %}
<p>Graphs that share the same spectrum for a given matrix type.</p>
<table>
    <thead>
        <tr>
            <th>Matrix</th>
            <th>Mates</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        {% if graph.cospectral_mates.adj %}
        <tr>
            <td>Adjacency</td>
            <td>
                {% for mate in graph.cospectral_mates.adj %}
                    <a href="/graph/{{ mate | urlencode }}"><code>{{ mate }}</code></a>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </td>
            <td>
                <a href="/compare?graphs={{ graph.graph6 | urlencode }},{{ graph.cospectral_mates.adj | join(',') | urlencode }}" role="button" class="outline">Compare</a>
            </td>
        </tr>
        {% endif %}
        {% if graph.cospectral_mates.lap %}
        <tr>
            <td>Laplacian</td>
            <td>
                {% for mate in graph.cospectral_mates.lap %}
                    <a href="/graph/{{ mate | urlencode }}"><code>{{ mate }}</code></a>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </td>
            <td>
                <a href="/compare?graphs={{ graph.graph6 | urlencode }},{{ graph.cospectral_mates.lap | join(',') | urlencode }}" role="button" class="outline">Compare</a>
            </td>
        </tr>
        {% endif %}
        {% if graph.cospectral_mates.nb %}
        <tr>
            <td>Non-backtracking</td>
            <td>
                {% for mate in graph.cospectral_mates.nb %}
                    <a href="/graph/{{ mate | urlencode }}"><code>{{ mate }}</code></a>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </td>
            <td>
                <a href="/compare?graphs={{ graph.graph6 | urlencode }},{{ graph.cospectral_mates.nb | join(',') | urlencode }}" role="button" class="outline">Compare</a>
            </td>
        </tr>
        {% endif %}
        {% if graph.cospectral_mates.nbl %}
        <tr>
            <td>NB-Laplacian</td>
            <td>
                {% for mate in graph.cospectral_mates.nbl %}
                    <a href="/graph/{{ mate | urlencode }}"><code>{{ mate }}</code></a>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </td>
            <td>
                <a href="/compare?graphs={{ graph.graph6 | urlencode }},{{ graph.cospectral_mates.nbl | join(',') | urlencode }}" role="button" class="outline">Compare</a>
            </td>
        </tr>
        {% endif %}
    </tbody>
</table>
{% else %}
<p><em>No cospectral mates for any matrix type.</em></p>
{% endif %}

<h3>Spectra</h3>
<details class="spectrum-box">
    <summary>Adjacency eigenvalues ({{ graph.spectra.adj_eigenvalues|length }})</summary>
    <div class="spectrum-content">
        <button class="copy-btn" onclick="copySpectrum(this)" aria-label="Copy to clipboard">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        </button>
        <pre><code>[{% for e in graph.spectra.adj_eigenvalues %}{{ "%.6f"|format(e) }}{% if not loop.last %}, {% endif %}{% endfor %}]</code></pre>
    </div>
</details>
<details class="spectrum-box">
    <summary>Laplacian eigenvalues ({{ graph.spectra.lap_eigenvalues|length }})</summary>
    <div class="spectrum-content">
        <button class="copy-btn" onclick="copySpectrum(this)" aria-label="Copy to clipboard">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        </button>
        <pre><code>[{% for e in graph.spectra.lap_eigenvalues %}{{ "%.6f"|format(e) }}{% if not loop.last %}, {% endif %}{% endfor %}]</code></pre>
    </div>
</details>
<details class="spectrum-box">
    <summary>Non-backtracking eigenvalues ({{ graph.spectra.nb_eigenvalues_re|length }})</summary>
    <div class="spectrum-content">
        <button class="copy-btn" onclick="copySpectrum(this)" aria-label="Copy to clipboard">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        </button>
        <pre><code>[{% for i in range(graph.spectra.nb_eigenvalues_re|length) %}{{ "%.6f"|format(graph.spectra.nb_eigenvalues_re[i]) }}{% if graph.spectra.nb_eigenvalues_im[i] >= 0 %}+{% endif %}{{ "%.6f"|format(graph.spectra.nb_eigenvalues_im[i]) }}j{% if not loop.last %}, {% endif %}{% endfor %}]</code></pre>
    </div>
</details>
<details class="spectrum-box">
    <summary>NB-Laplacian eigenvalues ({{ graph.spectra.nbl_eigenvalues_re|length }})</summary>
    <div class="spectrum-content">
        <button class="copy-btn" onclick="copySpectrum(this)" aria-label="Copy to clipboard">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
        </button>
        <pre><code>[{% for i in range(graph.spectra.nbl_eigenvalues_re|length) %}{{ "%.6f"|format(graph.spectra.nbl_eigenvalues_re[i]) }}{% if graph.spectra.nbl_eigenvalues_im[i] >= 0 %}+{% endif %}{{ "%.6f"|format(graph.spectra.nbl_eigenvalues_im[i]) }}j{% if not loop.last %}, {% endif %}{% endfor %}]</code></pre>
    </div>
</details>

<h3>Code</h3>
<div class="code-block">
    <button class="copy-btn" onclick="copySpectrum(this)" aria-label="Copy to clipboard">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
    </button>
<pre><code class="language-python">import networkx as nx

G = nx.from_graph6_bytes(b"{{ graph.graph6 }}")
print(G.number_of_nodes(), G.number_of_edges())  # {{ graph.n }} {{ graph.m }}</code></pre>
</div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css" id="prism-light">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-okaidia.min.css" id="prism-dark" disabled>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
<script>
function updatePrismTheme() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    document.getElementById('prism-light').disabled = isDark;
    document.getElementById('prism-dark').disabled = !isDark;
}
updatePrismTheme();
const observer = new MutationObserver(updatePrismTheme);
observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
</script>

<script>
function copySpectrum(btn) {
    const code = btn.parentElement.querySelector('code').textContent;
    navigator.clipboard.writeText(code).then(() => {
        btn.classList.add('copied');
        setTimeout(() => btn.classList.remove('copied'), 1500);
    });
}
</script>
{% endblock %}
