{% extends "base.html" %}

{% block title %}Compare - SMOL{% endblock %}

{% block content %}
<hgroup>
    <h1>Compare Graphs</h1>
    <p>Comparing {{ result.graphs|length }} graphs side by side.</p>
</hgroup>

<div class="compare-grid">
{% for g in result.graphs %}
    <div class="graph-card">
        <div style="text-align: center; margin-bottom: 0.5rem;">
            <a href="/graph/{{ g.graph6 | urlencode }}"><code>{{ g.graph6 }}</code></a>
        </div>
        <div class="viz-container">
            <div id="viz-{{ loop.index0 }}" class="graph-viz" style="width: 180px; height: 180px;"></div>
            <button class="viz-reset-btn" onclick="resetCompareViz({{ loop.index0 }})" title="Reset view">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
            </button>
        </div>
    </div>
{% endfor %}
</div>

<article>
    <header>
        <strong>{% if result.graphs|length == 2 %}Spectral Distance{% else %}Spectral Comparison{% endif %}</strong>
    </header>
    <p>
        {% for matrix, status in result.spectral_comparison.items() %}
            <strong>{{ matrix }}:</strong>
            {% if status in ('same', 'different') %}
                <span class="badge badge-{{ status }}">{{ status }}</span>
            {% elif status == '0.0000' %}
                <code style="color: var(--pico-primary);">{{ status }}</code>
                <span class="mate-badge">mate</span>
            {% else %}
                <code>{{ status }}</code>
            {% endif %}
            {% if not loop.last %}&nbsp;&nbsp;{% endif %}
        {% endfor %}
    </p>
</article>

<script>
const compareVizStates = [];

function resetCompareViz(idx) {
    if (compareVizStates[idx]) {
        compareVizStates[idx].transform.x = 0;
        compareVizStates[idx].transform.y = 0;
        compareVizStates[idx].transform.k = 1;
        compareVizStates[idx].update();
    }
}

function renderGraphs() {
    const graphs = {{ result.graphs | tojson }};
    graphs.forEach((g, idx) => {
        const width = 180, height = 180;
        const nodes = Array.from({length: g.n}, (_, i) => ({id: i}));
        const links = g.edges.map(([s, t]) => ({source: s, target: t}));

        const svg = d3.select("#viz-" + idx)
            .append("svg")
            .attr("width", width)
            .attr("height", height)
            .style("cursor", "grab");

        // Container group for panning
        const container = svg.append("g");

        // Viewport pan and zoom
        let transform = {x: 0, y: 0, k: 1};

        function updateTransform() {
            container.attr("transform", `translate(${transform.x},${transform.y}) scale(${transform.k})`);
        }

        // Store for reset button
        compareVizStates[idx] = { transform, update: updateTransform };

        svg.call(d3.drag()
            .on("start", () => svg.style("cursor", "grabbing"))
            .on("drag", (event) => {
                transform.x += event.dx;
                transform.y += event.dy;
                updateTransform();
            })
            .on("end", () => svg.style("cursor", "grab")));

        svg.on("wheel", (event) => {
            event.preventDefault();
            const scaleFactor = event.deltaY > 0 ? 0.9 : 1.1;
            const newK = Math.max(0.2, Math.min(5, transform.k * scaleFactor));

            // Get mouse position relative to SVG
            const [mx, my] = d3.pointer(event, svg.node());

            // Zoom centered on mouse position
            transform.x = mx - (mx - transform.x) * (newK / transform.k);
            transform.y = my - (my - transform.y) * (newK / transform.k);
            transform.k = newK;

            updateTransform();
        });

        const simulation = d3.forceSimulation(nodes)
            .force("link", d3.forceLink(links).id(d => d.id).distance(35))
            .force("charge", d3.forceManyBody().strength(-80))
            .force("center", d3.forceCenter(width / 2, height / 2));

        const style = getComputedStyle(document.documentElement);
        const nodeColor = style.getPropertyValue('--graph-node-color').trim();
        const edgeColor = style.getPropertyValue('--graph-edge-color').trim();

        const link = container.append("g")
            .selectAll("line")
            .data(links)
            .join("line")
            .attr("stroke", edgeColor)
            .attr("stroke-width", 2);

        const node = container.append("g")
            .selectAll("circle")
            .data(nodes)
            .join("circle")
            .attr("r", 5)
            .attr("fill", nodeColor)
            .style("cursor", "pointer")
            .call(d3.drag()
                .on("start", (event, d) => {
                    if (!event.active) simulation.alphaTarget(0.3).restart();
                    d.fx = d.x;
                    d.fy = d.y;
                    event.sourceEvent.stopPropagation();
                })
                .on("drag", (event, d) => {
                    d.fx = event.x;
                    d.fy = event.y;
                })
                .on("end", (event, d) => {
                    if (!event.active) simulation.alphaTarget(0);
                    d.fx = null;
                    d.fy = null;
                }));

        const padding = 8;
        simulation.on("tick", () => {
            // Constrain nodes to viewport
            nodes.forEach(d => {
                d.x = Math.max(padding, Math.min(width - padding, d.x));
                d.y = Math.max(padding, Math.min(height - padding, d.y));
            });

            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);
            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
        });
    });
}
</script>
<script src="https://d3js.org/d3.v7.min.js" onload="renderGraphs()"></script>

<h3>Properties</h3>
<div style="overflow-x: auto;">
<table>
    <thead>
        <tr>
            <th>Property</th>
            {% for g in result.graphs %}
            <th><a href="/graph/{{ g.graph6 | urlencode }}"><code>{{ g.graph6 }}</code></a></th>
            {% endfor %}
        </tr>
    </thead>
    <tbody>
        <tr{% if prop_diffs.n %} class="row-diff"{% endif %}>
            <td>Vertices</td>
            {% for g in result.graphs %}<td>{{ g.n }}</td>{% endfor %}
        </tr>
        <tr{% if prop_diffs.m %} class="row-diff"{% endif %}>
            <td>Edges</td>
            {% for g in result.graphs %}<td>{{ g.m }}</td>{% endfor %}
        </tr>
        <tr{% if prop_diffs.tags %} class="row-diff"{% endif %}>
            <td>Tags</td>
            {% for g in result.graphs %}
            {% set all_tags = g.tags | default([]) | list %}
            {% if g.properties.is_bipartite and 'bipartite' not in all_tags %}{% set _ = all_tags.append('bipartite') %}{% endif %}
            {% if g.properties.is_planar and 'planar' not in all_tags %}{% set _ = all_tags.append('planar') %}{% endif %}
            {% if g.properties.is_regular and 'regular' not in all_tags %}{% set _ = all_tags.append('regular') %}{% endif %}
            <td>{% for tag in all_tags | sort %}<span class="tag tag-sm">{{ tag }}</span>{% endfor %}</td>
            {% endfor %}
        </tr>
        <tr{% if prop_diffs.diameter %} class="row-diff"{% endif %}>
            <td>Diameter</td>
            {% for g in result.graphs %}<td>{{ g.properties.diameter if g.properties.diameter else "-" }}</td>{% endfor %}
        </tr>
        <tr{% if prop_diffs.girth %} class="row-diff"{% endif %}>
            <td>Girth</td>
            {% for g in result.graphs %}<td>{{ g.properties.girth if g.properties.girth else "-" }}</td>{% endfor %}
        </tr>
        <tr{% if prop_diffs.triangle_count %} class="row-diff"{% endif %}>
            <td>Triangles</td>
            {% for g in result.graphs %}<td>{{ g.properties.triangle_count }}</td>{% endfor %}
        </tr>
        {% if result.graphs[0].properties.clique_number is not none %}
        <tr{% if prop_diffs.clique_number %} class="row-diff"{% endif %}>
            <td>Clique number</td>
            {% for g in result.graphs %}<td>{{ g.properties.clique_number if g.properties.clique_number else "-" }}</td>{% endfor %}
        </tr>
        {% endif %}
        {% if result.graphs[0].properties.chromatic_number is not none %}
        <tr{% if prop_diffs.chromatic_number %} class="row-diff"{% endif %}>
            <td>Chromatic number</td>
            {% for g in result.graphs %}<td>{{ g.properties.chromatic_number if g.properties.chromatic_number else "-" }}</td>{% endfor %}
        </tr>
        {% endif %}
        {% if result.graphs[0].properties.algebraic_connectivity is not none %}
        <tr{% if prop_diffs.algebraic_connectivity %} class="row-diff"{% endif %}>
            <td>Algebraic connectivity</td>
            {% for g in result.graphs %}<td>{{ "%.4f"|format(g.properties.algebraic_connectivity) if g.properties.algebraic_connectivity is not none else "-" }}</td>{% endfor %}
        </tr>
        {% endif %}
        {% if result.graphs[0].properties.global_clustering is not none %}
        <tr{% if prop_diffs.global_clustering %} class="row-diff"{% endif %}>
            <td>Global clustering</td>
            {% for g in result.graphs %}<td>{{ "%.4f"|format(g.properties.global_clustering) if g.properties.global_clustering is not none else "-" }}</td>{% endfor %}
        </tr>
        {% endif %}
        {% if result.graphs[0].properties.avg_local_clustering is not none %}
        <tr{% if prop_diffs.avg_local_clustering %} class="row-diff"{% endif %}>
            <td>Avg local clustering</td>
            {% for g in result.graphs %}<td>{{ "%.4f"|format(g.properties.avg_local_clustering) if g.properties.avg_local_clustering is not none else "-" }}</td>{% endfor %}
        </tr>
        {% endif %}
        {% if result.graphs[0].properties.avg_path_length is not none %}
        <tr{% if prop_diffs.avg_path_length %} class="row-diff"{% endif %}>
            <td>Avg path length</td>
            {% for g in result.graphs %}<td>{{ "%.4f"|format(g.properties.avg_path_length) if g.properties.avg_path_length is not none else "-" }}</td>{% endfor %}
        </tr>
        {% endif %}
        {% if result.graphs[0].properties.assortativity is not none %}
        <tr{% if prop_diffs.assortativity %} class="row-diff"{% endif %}>
            <td>Degree assortativity</td>
            {% for g in result.graphs %}<td>{{ "%.4f"|format(g.properties.assortativity) if g.properties.assortativity is not none else "-" }}</td>{% endfor %}
        </tr>
        {% endif %}
    </tbody>
</table>
</div>

<style>
    .mate-badge {
        display: inline-block;
        margin-left: 0.5rem;
        padding: 0.1rem 0.4rem;
        background: var(--pico-primary);
        color: white;
        font-size: 0.65rem;
        font-weight: 600;
        text-transform: uppercase;
        border-radius: 3px;
        vertical-align: middle;
    }
</style>
{% endblock %}
