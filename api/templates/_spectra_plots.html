{% macro render_split_spectra_plots(container_prefix, show_graph_toggles=True) %}
<div style="display: flex; gap: 2rem;">
    <div class="viz-container" style="flex: 1;">
        <div id="{{ container_prefix }}-real-plot" style="height: 280px;"></div>
        <button class="viz-reset-btn" onclick="reset{{ container_prefix|title|replace('-', '') }}RealPlot()" title="Reset view">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        </button>
    </div>
    <div class="viz-container" style="flex: 1;">
        <div id="{{ container_prefix }}-complex-plot" style="height: 280px;"></div>
        <button class="viz-reset-btn" onclick="reset{{ container_prefix|title|replace('-', '') }}ComplexPlot()" title="Reset view">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        </button>
    </div>
</div>
{% endmacro %}

{% macro spectra_plot_scripts(container_prefix, graphs_data) %}
<script>
// Real eigenvalue plot (adj, kirchhoff, signless, lap)
function render{{ container_prefix|title|replace('-', '') }}RealPlot() {
    const graphs = {{ graphs_data | tojson }};
    const container = document.getElementById('{{ container_prefix }}-real-plot');
    if (!container || graphs.length === 0) return;

    container.innerHTML = '';

    const graphsSpectra = graphs.map((g, idx) => ({
        graphIndex: idx,
        graph6: g.graph6,
        spectra: {
            adj: g.spectra.adj_eigenvalues.map(re => ({re, im: 0})),
            kirchhoff: (g.spectra.kirchhoff_eigenvalues || []).map(re => ({re, im: 0})),
            signless: (g.spectra.signless_eigenvalues || []).map(re => ({re, im: 0})),
            lap: g.spectra.lap_eigenvalues.map(re => ({re, im: 0}))
        }
    }));

    const width = container.clientWidth || 500;
    const height = 280;
    const margin = {top: 10, right: 20, bottom: 45, left: 80};
    const plotWidth = width - margin.left - margin.right;
    const plotHeight = height - margin.top - margin.bottom;

    const matrices = ['adj', 'kirchhoff', 'signless', 'lap'];
    const laneHeight = plotHeight / matrices.length;

    const allReals = [];
    graphsSpectra.forEach(gs => {
        matrices.forEach(matrix => {
            gs.spectra[matrix].forEach(p => allReals.push(p.re));
        });
    });

    const reExtent = d3.extent(allReals);
    const rePadding = (reExtent[1] - reExtent[0]) * 0.1 || 0.5;

    const xScale = d3.scaleLinear()
        .domain([reExtent[0] - rePadding, reExtent[1] + rePadding])
        .range([0, plotWidth]);

    const svg = d3.select('#{{ container_prefix }}-real-plot')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    let transform = d3.zoomIdentity;
    const zoom = d3.zoom()
        .scaleExtent([0.5, 10])
        .on('zoom', (event) => {
            transform = event.transform;
            content.attr('transform', transform);
        });

    svg.call(zoom);

    const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

    const content = g.append('g').attr('class', 'plot-content');

    const tooltip = d3.select('body').append('div')
        .attr('class', 'spectrum-tooltip')
        .style('position', 'absolute')
        .style('visibility', 'hidden')
        .style('background', 'var(--pico-card-background-color)')
        .style('border', '1px solid var(--pico-muted-border-color)')
        .style('border-radius', '4px')
        .style('padding', '4px 8px')
        .style('font-size', '12px')
        .style('pointer-events', 'none')
        .style('z-index', '1000');

    const style = getComputedStyle(document.documentElement);
    const axisColor = style.getPropertyValue('--pico-muted-color').trim() || '#666';
    const borderColor = style.getPropertyValue('--pico-muted-border-color').trim() || '#ddd';

    const xAxis = g.append('g')
        .attr('transform', `translate(0,${plotHeight})`)
        .call(d3.axisBottom(xScale).ticks(6));
    xAxis.selectAll('text').attr('fill', axisColor).attr('stroke', 'none');
    xAxis.selectAll('line, path').attr('stroke', borderColor);

    g.append('text')
        .attr('x', plotWidth / 2)
        .attr('y', plotHeight + 35)
        .attr('text-anchor', 'middle')
        .attr('fill', axisColor)
        .attr('font-size', '11px')
        .text('Eigenvalue');

    const colors = {
        adj: style.getPropertyValue('--spectrum-adj').trim(),
        kirchhoff: style.getPropertyValue('--spectrum-kirchhoff').trim() || '#8B4513',
        signless: style.getPropertyValue('--spectrum-signless').trim() || '#F97316',
        lap: style.getPropertyValue('--spectrum-lap').trim()
    };

    const labels = {adj: 'adj', kirchhoff: 'kir', signless: 'sgl', lap: 'lap'};

    const markerShapes = [
        { name: 'circle', type: null },
        { name: 'square', type: null },
        { name: 'triangle', type: d3.symbolTriangle },
        { name: 'diamond', type: d3.symbolDiamond },
        { name: 'cross', type: d3.symbolCross },
        { name: 'star', type: d3.symbolStar }
    ];

    matrices.forEach((matrix, i) => {
        const laneY = i * laneHeight;

        g.append('text')
            .attr('x', -10)
            .attr('y', laneY + laneHeight / 2)
            .attr('text-anchor', 'end')
            .attr('dominant-baseline', 'middle')
            .attr('fill', colors[matrix])
            .attr('font-size', '11px')
            .attr('font-weight', '600')
            .text(labels[matrix]);

        const numGraphs = graphsSpectra.length;
        const tickValues = xScale.ticks(6);
        for (let graphIdx = 0; graphIdx < numGraphs; graphIdx++) {
            const yPos = laneY + laneHeight * ((graphIdx + 1) / (numGraphs + 1));
            content.append('line')
                .attr('x1', 0)
                .attr('x2', plotWidth)
                .attr('y1', yPos)
                .attr('y2', yPos)
                .attr('stroke', borderColor)
                .attr('stroke-opacity', 0.4)
                .attr('stroke-width', 1);

            tickValues.forEach(tickValue => {
                const tickX = xScale(tickValue);
                content.append('line')
                    .attr('x1', tickX)
                    .attr('x2', tickX)
                    .attr('y1', yPos - 3)
                    .attr('y2', yPos + 3)
                    .attr('stroke', borderColor)
                    .attr('stroke-opacity', 0.4)
                    .attr('stroke-width', 1);
            });
        }

        graphsSpectra.forEach((gs, graphIdx) => {
            const markerInfo = markerShapes[graphIdx % markerShapes.length];
            const points = gs.spectra[matrix];
            const yPos = laneY + laneHeight * ((graphIdx + 1) / (numGraphs + 1));
            const baseRadius = 3.5;

            if (markerInfo.name === 'circle') {
                content.append('g')
                    .attr('class', `spectrum-points spectrum-${matrix} graph-${graphIdx}`)
                    .selectAll('circle')
                    .data(points)
                    .join('circle')
                    .attr('class', 'eigenvalue-dot')
                    .attr('cx', d => xScale(d.re))
                    .attr('cy', yPos)
                    .attr('r', baseRadius)
                    .attr('fill', colors[matrix])
                    .attr('opacity', 0.7)
                    .style('cursor', 'pointer')
                    .on('mouseover', (event, d) => {
                        tooltip.style('visibility', 'visible')
                            .html(`<strong>${labels[matrix]}:</strong> ${d.re.toFixed(4)}<br/><code style="font-size:10px;">${gs.graph6}</code>`);
                        d3.select(event.target).attr('r', 6 / transform.k).attr('opacity', 1);
                    })
                    .on('mousemove', (event) => {
                        tooltip.style('top', (event.pageY - 10) + 'px').style('left', (event.pageX + 10) + 'px');
                    })
                    .on('mouseout', (event) => {
                        tooltip.style('visibility', 'hidden');
                        d3.select(event.target).attr('r', baseRadius / transform.k).attr('opacity', 0.7);
                    });
            } else if (markerInfo.name === 'square') {
                content.append('g')
                    .attr('class', `spectrum-points spectrum-${matrix} graph-${graphIdx}`)
                    .selectAll('rect')
                    .data(points)
                    .join('rect')
                    .attr('class', 'eigenvalue-square')
                    .attr('x', d => xScale(d.re) - baseRadius)
                    .attr('y', yPos - baseRadius)
                    .attr('width', baseRadius * 2)
                    .attr('height', baseRadius * 2)
                    .attr('fill', colors[matrix])
                    .attr('opacity', 0.7)
                    .style('cursor', 'pointer')
                    .on('mouseover', (event, d) => {
                        tooltip.style('visibility', 'visible')
                            .html(`<strong>${labels[matrix]}:</strong> ${d.re.toFixed(4)}<br/><code style="font-size:10px;">${gs.graph6}</code>`);
                        d3.select(event.target)
                            .attr('width', 12 / transform.k)
                            .attr('height', 12 / transform.k)
                            .attr('x', xScale(d.re) - 6 / transform.k)
                            .attr('y', yPos - 6 / transform.k)
                            .attr('opacity', 1);
                    })
                    .on('mousemove', (event) => {
                        tooltip.style('top', (event.pageY - 10) + 'px').style('left', (event.pageX + 10) + 'px');
                    })
                    .on('mouseout', (event, d) => {
                        tooltip.style('visibility', 'hidden');
                        d3.select(event.target)
                            .attr('width', baseRadius * 2 / transform.k)
                            .attr('height', baseRadius * 2 / transform.k)
                            .attr('x', xScale(d.re) - baseRadius / transform.k)
                            .attr('y', yPos - baseRadius / transform.k)
                            .attr('opacity', 0.7);
                    });
            } else {
                content.append('g')
                    .attr('class', `spectrum-points spectrum-${matrix} graph-${graphIdx}`)
                    .selectAll('path')
                    .data(points.map(p => ({...p, symbolType: markerInfo.type})))
                    .join('path')
                    .attr('class', 'eigenvalue-symbol')
                    .attr('d', d3.symbol().type(markerInfo.type).size(50))
                    .attr('transform', d => `translate(${xScale(d.re)},${yPos})`)
                    .attr('fill', colors[matrix])
                    .attr('opacity', 0.7)
                    .style('cursor', 'pointer')
                    .on('mouseover', (event, d) => {
                        tooltip.style('visibility', 'visible')
                            .html(`<strong>${labels[matrix]}:</strong> ${d.re.toFixed(4)}<br/><code style="font-size:10px;">${gs.graph6}</code>`);
                        d3.select(event.target).attr('d', d3.symbol().type(markerInfo.type).size(100 / (transform.k * transform.k)))
                            .attr('opacity', 1);
                    })
                    .on('mousemove', (event) => {
                        tooltip.style('top', (event.pageY - 10) + 'px').style('left', (event.pageX + 10) + 'px');
                    })
                    .on('mouseout', (event, d) => {
                        tooltip.style('visibility', 'hidden');
                        d3.select(event.target).attr('d', d3.symbol().type(markerInfo.type).size(50 / (transform.k * transform.k)))
                            .attr('opacity', 0.7);
                    });
            }
        });
    });

    return () => tooltip.remove();
}

// Complex eigenvalue plot (nb, nbl)
function render{{ container_prefix|title|replace('-', '') }}ComplexPlot() {
    const graphs = {{ graphs_data | tojson }};
    const container = document.getElementById('{{ container_prefix }}-complex-plot');
    if (!container || graphs.length === 0) return;

    container.innerHTML = '';

    const graphsSpectra = graphs.map((g, idx) => ({
        graphIndex: idx,
        graph6: g.graph6,
        spectra: {
            nb: g.spectra.nb_eigenvalues_re.map((re, i) => ({re, im: g.spectra.nb_eigenvalues_im[i]})),
            nbl: g.spectra.nbl_eigenvalues_re.map((re, i) => ({re, im: g.spectra.nbl_eigenvalues_im[i]}))
        }
    }));

    const width = container.clientWidth || 500;
    const height = 280;
    const margin = {top: 20, right: 20, bottom: 40, left: 50};
    const plotWidth = width - margin.left - margin.right;
    const plotHeight = height - margin.top - margin.bottom;

    function withConjugates(eigenvalues) {
        const result = [];
        eigenvalues.forEach(ev => {
            result.push(ev);
            if (Math.abs(ev.im) > 1e-10) {
                result.push({re: ev.re, im: -ev.im});
            }
        });
        return result;
    }

    const plotData = graphsSpectra.map(gs => ({
        ...gs,
        plotSpectra: {
            nb: withConjugates(gs.spectra.nb),
            nbl: withConjugates(gs.spectra.nbl)
        }
    }));

    const allPoints = [];
    plotData.forEach(gs => {
        ['nb', 'nbl'].forEach(matrix => {
            gs.plotSpectra[matrix].forEach(p => allPoints.push(p));
        });
    });

    const reExtent = d3.extent(allPoints, d => d.re);
    const imExtent = d3.extent(allPoints, d => d.im);
    const rePadding = (reExtent[1] - reExtent[0]) * 0.1 || 0.5;
    const imPadding = (imExtent[1] - imExtent[0]) * 0.1 || 0.5;

    const xScale = d3.scaleLinear()
        .domain([reExtent[0] - rePadding, reExtent[1] + rePadding])
        .range([0, plotWidth]);

    const yScale = d3.scaleLinear()
        .domain([imExtent[0] - imPadding, imExtent[1] + imPadding])
        .range([plotHeight, 0]);

    const svg = d3.select('#{{ container_prefix }}-complex-plot')
        .append('svg')
        .attr('width', width)
        .attr('height', height);

    let transform = d3.zoomIdentity;
    const zoom = d3.zoom()
        .scaleExtent([0.5, 10])
        .on('zoom', (event) => {
            transform = event.transform;
            content.attr('transform', transform);
        });

    svg.call(zoom);

    const g = svg.append('g')
        .attr('transform', `translate(${margin.left},${margin.top})`);

    const content = g.append('g').attr('class', 'plot-content');

    const tooltip = d3.select('body').append('div')
        .attr('class', 'spectrum-tooltip')
        .style('position', 'absolute')
        .style('visibility', 'hidden')
        .style('background', 'var(--pico-card-background-color)')
        .style('border', '1px solid var(--pico-muted-border-color)')
        .style('border-radius', '4px')
        .style('padding', '4px 8px')
        .style('font-size', '12px')
        .style('pointer-events', 'none')
        .style('z-index', '1000');

    const style = getComputedStyle(document.documentElement);
    const axisColor = style.getPropertyValue('--pico-muted-color').trim() || '#666';
    const borderColor = style.getPropertyValue('--pico-muted-border-color').trim() || '#ddd';

    const xAxis = g.append('g')
        .attr('transform', `translate(0,${plotHeight})`)
        .call(d3.axisBottom(xScale).ticks(6));
    xAxis.selectAll('text').attr('fill', axisColor).attr('stroke', 'none');
    xAxis.selectAll('line, path').attr('stroke', borderColor);

    const yAxis = g.append('g')
        .call(d3.axisLeft(yScale).ticks(6));
    yAxis.selectAll('text').attr('fill', axisColor).attr('stroke', 'none');
    yAxis.selectAll('line, path').attr('stroke', borderColor);

    g.append('text')
        .attr('x', plotWidth / 2)
        .attr('y', plotHeight + 32)
        .attr('text-anchor', 'middle')
        .attr('fill', axisColor)
        .attr('font-size', '11px')
        .text('Re');

    g.append('text')
        .attr('transform', 'rotate(-90)')
        .attr('x', -plotHeight / 2)
        .attr('y', -32)
        .attr('text-anchor', 'middle')
        .attr('fill', axisColor)
        .attr('font-size', '11px')
        .text('Im');

    if (xScale.domain()[0] < 0 && xScale.domain()[1] > 0) {
        content.append('line')
            .attr('x1', xScale(0))
            .attr('x2', xScale(0))
            .attr('y1', 0)
            .attr('y2', plotHeight)
            .attr('stroke', axisColor)
            .attr('stroke-opacity', 0.3)
            .attr('stroke-dasharray', '4,4');
    }
    if (yScale.domain()[0] < 0 && yScale.domain()[1] > 0) {
        content.append('line')
            .attr('x1', 0)
            .attr('x2', plotWidth)
            .attr('y1', yScale(0))
            .attr('y2', yScale(0))
            .attr('stroke', axisColor)
            .attr('stroke-opacity', 0.3)
            .attr('stroke-dasharray', '4,4');
    }

    const colors = {
        nb: style.getPropertyValue('--spectrum-nb').trim(),
        nbl: style.getPropertyValue('--spectrum-nbl').trim()
    };

    const labels = {nb: 'nb', nbl: 'nbl'};

    const circleRadius = Math.abs(xScale(1) - xScale(0));
    content.append('circle')
        .attr('class', 'unit-circle')
        .attr('cx', xScale(0))
        .attr('cy', yScale(0))
        .attr('r', circleRadius)
        .attr('fill', 'none')
        .attr('stroke', axisColor)
        .attr('stroke-opacity', 0.2)
        .attr('stroke-dasharray', '4,4');

    function formatEig(d) {
        const re = d.re.toFixed(4);
        const im = d.im.toFixed(4);
        if (Math.abs(d.im) < 1e-10) return re;
        const sign = d.im >= 0 ? '+' : '';
        return `${re}${sign}${im}i`;
    }

    const markerShapes = [
        { name: 'circle', type: null },
        { name: 'square', type: null },
        { name: 'triangle', type: d3.symbolTriangle },
        { name: 'diamond', type: d3.symbolDiamond },
        { name: 'cross', type: d3.symbolCross },
        { name: 'star', type: d3.symbolStar }
    ];

    ['nb', 'nbl'].forEach(matrix => {
        plotData.forEach((gs, graphIdx) => {
            const markerInfo = markerShapes[graphIdx % markerShapes.length];
            const points = gs.plotSpectra[matrix];
            const baseRadius = 3.5;

            if (markerInfo.name === 'circle') {
                content.append('g')
                    .attr('class', `spectrum-points spectrum-${matrix} graph-${graphIdx}`)
                    .selectAll('circle')
                    .data(points)
                    .join('circle')
                    .attr('class', 'eigenvalue-dot')
                    .attr('cx', d => xScale(d.re))
                    .attr('cy', d => yScale(d.im))
                    .attr('r', baseRadius)
                    .attr('fill', colors[matrix])
                    .attr('opacity', 0.7)
                    .style('cursor', 'pointer')
                    .on('mouseover', (event, d) => {
                        tooltip.style('visibility', 'visible')
                            .html(`<strong>${labels[matrix]}:</strong> ${formatEig(d)}<br/><code style="font-size:10px;">${gs.graph6}</code>`);
                        d3.select(event.target).attr('r', 6 / transform.k).attr('opacity', 1);
                    })
                    .on('mousemove', (event) => {
                        tooltip.style('top', (event.pageY - 10) + 'px')
                            .style('left', (event.pageX + 10) + 'px');
                    })
                    .on('mouseout', (event) => {
                        tooltip.style('visibility', 'hidden');
                        d3.select(event.target).attr('r', baseRadius / transform.k).attr('opacity', 0.7);
                    });
            } else if (markerInfo.name === 'square') {
                content.append('g')
                    .attr('class', `spectrum-points spectrum-${matrix} graph-${graphIdx}`)
                    .selectAll('rect')
                    .data(points)
                    .join('rect')
                    .attr('class', 'eigenvalue-square')
                    .attr('x', d => xScale(d.re) - baseRadius)
                    .attr('y', d => yScale(d.im) - baseRadius)
                    .attr('width', baseRadius * 2)
                    .attr('height', baseRadius * 2)
                    .attr('fill', colors[matrix])
                    .attr('opacity', 0.7)
                    .style('cursor', 'pointer')
                    .on('mouseover', (event, d) => {
                        tooltip.style('visibility', 'visible')
                            .html(`<strong>${labels[matrix]}:</strong> ${formatEig(d)}<br/><code style="font-size:10px;">${gs.graph6}</code>`);
                        d3.select(event.target)
                            .attr('width', baseRadius * 2 / transform.k)
                            .attr('height', baseRadius * 2 / transform.k)
                            .attr('x', xScale(d.re) - baseRadius / transform.k)
                            .attr('y', yScale(d.im) - baseRadius / transform.k)
                            .attr('opacity', 1);
                    })
                    .on('mousemove', (event) => {
                        tooltip.style('top', (event.pageY - 10) + 'px')
                            .style('left', (event.pageX + 10) + 'px');
                    })
                    .on('mouseout', (event, d) => {
                        tooltip.style('visibility', 'hidden');
                        d3.select(event.target)
                            .attr('width', baseRadius * 2 / transform.k)
                            .attr('height', baseRadius * 2 / transform.k)
                            .attr('x', xScale(d.re) - baseRadius / transform.k)
                            .attr('y', yScale(d.im) - baseRadius / transform.k)
                            .attr('opacity', 0.7);
                    });
            } else {
                content.append('g')
                    .attr('class', `spectrum-points spectrum-${matrix} graph-${graphIdx}`)
                    .selectAll('path')
                    .data(points.map(p => ({...p, symbolType: markerInfo.type})))
                    .join('path')
                    .attr('class', 'eigenvalue-symbol')
                    .attr('d', d3.symbol().type(markerInfo.type).size(50))
                    .attr('transform', d => `translate(${xScale(d.re)},${yScale(d.im)})`)
                    .attr('fill', colors[matrix])
                    .attr('opacity', 0.7)
                    .style('cursor', 'pointer')
                    .on('mouseover', (event, d) => {
                        tooltip.style('visibility', 'visible')
                            .html(`<strong>${labels[matrix]}:</strong> ${formatEig(d)}<br/><code style="font-size:10px;">${gs.graph6}</code>`);
                        d3.select(event.target).attr('d', d3.symbol().type(markerInfo.type).size(100 / (transform.k * transform.k)))
                            .attr('opacity', 1);
                    })
                    .on('mousemove', (event) => {
                        tooltip.style('top', (event.pageY - 10) + 'px')
                            .style('left', (event.pageX + 10) + 'px');
                    })
                    .on('mouseout', (event, d) => {
                        tooltip.style('visibility', 'hidden');
                        d3.select(event.target).attr('d', d3.symbol().type(markerInfo.type).size(50 / (transform.k * transform.k)))
                            .attr('opacity', 0.7);
                    });
            }
        });
    });

    const legend = g.append('g')
        .attr('class', 'spectrum-legend')
        .attr('transform', `translate(${plotWidth - 10}, 10)`);

    const legendItems = [
        { label: 'nb', color: colors.nb },
        { label: 'nbl', color: colors.nbl }
    ];

    legendItems.forEach((item, i) => {
        const legendRow = legend.append('g')
            .attr('transform', `translate(0, ${i * 18})`);

        legendRow.append('text')
            .attr('text-anchor', 'end')
            .attr('fill', item.color)
            .attr('font-size', '11px')
            .text(item.label);
    });

    return () => tooltip.remove();
}

// Reset functions
function reset{{ container_prefix|title|replace('-', '') }}RealPlot() {
    render{{ container_prefix|title|replace('-', '') }}RealPlot();
}

function reset{{ container_prefix|title|replace('-', '') }}ComplexPlot() {
    render{{ container_prefix|title|replace('-', '') }}ComplexPlot();
}
</script>
{% endmacro %}
